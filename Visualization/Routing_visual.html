<!DOCTYPE html>
<html>

<head>
    <meta charset="utf-8">
    <meta name="description" content="Visible A* search algorithm, fulfill by HTML5 canvas, concerntrate the performance in JavaScript">
    <meta name="author" content="Xiong Jie">
    <title>A* search algorithm in JavaScript</title>
    <link rel="stylesheet" type="text/css" href="testPage.css">
    <script type="text/javascript" src="../Utils/heuristic.js"></script>
    <script type="text/javascript" src="../DataStructure/minHeap.js"></script>
    <script type="text/javascript" src="../DataStructure/tile.js"></script>
    <script type="text/javascript" src="../DataStructure/nodeType.js"></script>
    <script type="text/javascript" src="../Algorithms/AStar.js"></script>
    <script type="text/javascript" src="../Test/Maps/simpleStraight.js"></script>
    <script type="text/javascript" src="../Test/Maps/simplePoly.js"></script>
    <script type="text/javascript" src="../Test/Maps/simpleObs.js"></script>
</head>

<body>
    <div class="algorithm">
        Algorithms:
        <form>
            <select id="Algorithms">
                <option value="Astar">A*</option>
                <option value="Depth">Depth first</option>
            </select>
        </form>
    </div>
    <div class="Maps">
        Maps:
        <form>
            <select id="maps">
                <option value="simpleStraight">simpleStraight</option>
                <option value="simplePoly">simplePoly</option>
                <option value="simpleObs">simpleObs</option>
            </select>
        </form>
    </div>
    <button type="button" onclick="init()">init</button>
    <button type="button" onclick="run()">run</button>
</body>

<script>
    "use strict";

    var gridSize, tileSize, margin, ctx, startP, goalP, map;

    function init() {

        map = window[document.getElementById("maps").value].map;

        var canvas = document.getElementById("routingMap");
        if (!canvas) {
            var canvas = document.createElement("canvas");
            canvas.id = "routingMap";
        }

        gridSize = 20;
        tileSize = 18;
        margin = 1;

        canvas.width = map[0].length * gridSize;
        canvas.height = map.length * gridSize;
        canvas.style.position = "absolute";
        canvas.style.top = "120px";
        canvas.style.left = "20px";
        canvas.style.border = "1px solid #000000";
        document.body.appendChild(canvas);

        ctx = canvas.getContext("2d");

        map.forEach(function(row, rowNum) {
            row.forEach(function(tileType, colNum) {
                switch (tileType) {
                    case NODETYPE.OPEN:
                        ctx.fillStyle = "#E0E0E0";
                        ctx.fillRect(margin + colNum * gridSize, margin + rowNum * gridSize, tileSize, tileSize);
                        break;

                    case NODETYPE.CLOSE:
                        ctx.fillStyle = "#707070";
                        ctx.fillRect(margin + colNum * gridSize, margin + rowNum * gridSize, tileSize, tileSize);
                        break;

                    case NODETYPE.START:
                        startP = {
                            x: rowNum,
                            y: colNum
                        };
                        ctx.fillStyle = "red";
                        ctx.fillRect(margin + colNum * gridSize, margin + rowNum * gridSize, tileSize, tileSize);
                        break;

                    case NODETYPE.GOAL:
                        goalP = {
                            x: rowNum,
                            y: colNum
                        };
                        ctx.fillStyle = "green";
                        ctx.fillRect(margin + colNum * gridSize, margin + rowNum * gridSize, tileSize, tileSize);
                        break;
                    default:
                }
            });
        });
    }

    function run() {
        var result = aStar(map);

        if (result) {
            var path = result.path;
            var searchedNode = result.searchedNode;

            var i = 0;
            var frame = function() {
                if (i === searchedNode.length) {
                    clearInterval(id);
                    i = path.length - 1;
                    id = setInterval(pathFrame, 33);
                } else {
                    var value = searchedNode[i];
                    i++;
                    if (!(value.x === goal.x && value.y === goal.y)) {
                        ctx.fillStyle = "#C0C0C0";
                        ctx.fillRect(margin + value.x * gridSize, margin + value.y * gridSize, tileSize, tileSize);
                    }
                }
            };

            var id = setInterval(frame, 33);

            var pathFrame = function() {
                if (i < 0) {
                    clearInterval(id);
                } else {
                    var value = path[i];
                    i--;
                    ctx.fillStyle = "orange";
                    ctx.fillRect(margin + value.x * gridSize, margin + value.y * gridSize, tileSize, tileSize);
                }
            };
        }
    }
</script>

</html>
